##### Load Packages #####
library(quantmod)
library(PerformanceAnalytics)
library(PortfolioAnalytics)
library(DEoptim)
library(fBasics)
library(ghyp)

##### Define the tokens of the assets #####
Symbols = c("AAPL","AMZN","IBM","MSFT","TSLA")

getSymbols(Symbols)

##### Combine the Adjusted Prices into a single matrix #####
Symbols_ad <- NULL
for(i in Symbols){
  assign(paste0("Ad_",i),Ad(get(i)))
  Symbols_ad <- c(Symbols_ad,paste0("Ad_",i))
}

Portfolio <- merge.xts(get(Symbols_ad[1]),
                       get(Symbols_ad[2]),
                       join = "inner")
for(i in 3:length(Symbols_ad)){
  Portfolio <- merge.xts(Portfolio,
                         get(Symbols_ad[i]),
                         join = "inner")
}
colnames(Portfolio) <- Symbols

##### Compute the returns of the portfolio #####
Returns <- Return.calculate(Portfolio)[-1,]


##### Create the Portfolio Object #####
Specs_Port1 <- portfolio.spec(Symbols)

##### Add Constraints #####
Specs_Port1 <- add.constraint(Specs_Port1,type="full_investment")
Specs_Port1 <- add.constraint(Specs_Port1,type="long_only")

##### Add Objective #####
Specs_Port1 <- add.objective(Specs_Port1,type="risk",name="StdDev")
Specs_Port1 <- add.objective(Specs_Port1,type='return',name='mean')
Specs_Port1

covnig<-function(R,portfolio){
  a<-fit.NIGmv(R,silent=TRUE)
  COV<-a@variance
  mu<-a@expected.value
  mu<-matrix(mu,ncol = 1)
  resultado<-list(mu=mu,sigma=COV)
  return(resultado)
}
covnig(Returns)


##### Optimization #####
Optimized_Port1 <- optimize.portfolio(Returns,
                                      Specs_Port1, 
                                      momentFUN = covnig)
Optimized_Port1


chart.Weights(Optimized_Port1)
plot.ty()
W <- extractWeights(Optimized_Port1)
W
sum(W)

cor(Returns)
##### Portfolio Evaluation #####
Return_opt <- Return.portfolio(Returns,W)

table.AnnualizedReturns(Return_opt,
                        scale = 252,
                        geometric = FALSE)
Return.cumulative(Return_opt,
                  geometric = FALSE)












###### Maximization of Return #####

Specs_Port2 <- portfolio.spec(Symbols)
Specs_Port2 <- add.constraint(Specs_Port2,type='full_investment')
Specs_Port2 <- add.constraint(Specs_Port2,type='long_only')
Specs_Port2 <- add.objective(Specs_Port2,type='return',name='mean')
Specs_Port2

Optimized_Port2 <- optimize.portfolio(Returns,Specs_Port2)

chart.Weights(Optimized_Port2)
W_R <- extractWeights(Optimized_Port2)
sum(W_R)

Return_opt2 <- Return.portfolio(Returns,W_R)
table.AnnualizedReturns(Return_opt2,
                        scale = 252,
                        geometric = FALSE)
Return.cumulative(Return_opt2,
                  geometric = FALSE)













##### Minimization of Volatility #####

Specs_Port3 <- portfolio.spec(Symbols)
Specs_Port3 <- add.constraint(Specs_Port3,type='full_investment')
Specs_Port3 <- add.constraint(Specs_Port3,type='long_only')
Specs_Port3 <- add.objective(Specs_Port3,type='risk',name='StdDev')
Specs_Port3

Optimized_Port3 <- optimize.portfolio(Returns,Specs_Port3)

chart.Weights(Optimized_Port3)
W_R <- extractWeights(Optimized_Port3)
sum(W_R)

Return_opt3 <- Return.portfolio(Returns,W_R)
table.AnnualizedReturns(Return_opt3,
                        scale = 252,
                        geometric = FALSE)
Return.cumulative(Return_opt3,
                  geometric = FALSE)













##### Changing the optimization algorithm #####

Specs_Port4 <- portfolio.spec(Symbols)
Specs_Port4 <- add.constraint(Specs_Port4, type='full_investment')
Specs_Port4 <- add.constraint(Specs_Port4, type='long_only')
Specs_Port4 <- add.objective(Specs_Port4, type='risk', name='StdDev')
Specs_Port4 <- add.objective(Specs_Port4, type='return', name='mean')

Optimized_Port4 <- optimize.portfolio(Returns,
                                     Specs_Port4,
                                     optimize_method = "random",
                                     trace = TRUE)

chart.Weights(Optimized_Port4, plot.type = "barplot")
W_R <- extractWeights(Optimized_Port4)
sum(W_R)

Return_opt4 <- Return.portfolio(Returns,W_R)
table.AnnualizedReturns(Return_opt4,
                        scale = 252,
                        geometric = FALSE)
Return.cumulative(Return_opt4,
                  geometric = FALSE)

chart.RiskReward(Optimized_Port4,
                 risk.col = 'StdDev',
                 return.col = 'mean',
                 chart.assets = T)













##### Testing for EW Portfolio #####

W_EW <- rep(1/length(Symbols),length(Symbols))

Return_opt5 <- Return.portfolio(Returns,W_EW)
table.AnnualizedReturns(Return_opt5,
                        scale = 252,
                        geometric = FALSE)
Return.cumulative(Return_opt5,
                  geometric = FALSE)
