---
title: "PORTAFOLIO DE ACTIVOS ALTERNATIVOS y ESG"
subtitle: "Tesis de Inversión & Análisis de Activos"
author: "FISHER's CAPITAL"
date: "3/30/2022"
output: 
  html_document:
    toc: TRUE
    toc_depth: 3
---
```{r, include=FALSE}
library(tidyverse)
library(quantmod)
library(PortfolioAnalytics)
library(fPortfolio)
library(PerformanceAnalytics)
library(readr)
library(psych)
library(DEoptim)
library(visdat)
library(ghyp)
```
# Perfil del Inversionista

Servicio asesorado a un perfil de inversionista 4 (todo tipo de productos), en un horizonte de tiempo de *Indicar años/meses*!!. Cliente: Banco Interamericano de Desarrollo.

# Tesis de Inversión

Lo más importante en la gestión de activos es garantizar flujos de efectivo constantes y estables, igual como reducir el riesgo del portafolio a través de la diversificación. 2022 no es ni como 2021, con gran crecimiento en los mercados de capitales o cómo 2020 que beneficio el mercado de deuda. Los activos alternativos nos ayudan a cumplir este objetivo de tener retornos constantes y estables en el panorama macroeconómico de hoy en día de crecimiento económico moderado, alta inflación y constantes subidas de tasas de interés.

La tesis de inversión de FISHER's CAPITAL sigue una estrategia *Global Macroeconómica*. Estudiamos indicadores macroeconómicos para entender en general la economía y el mercado. Nos enfocamos en los mercados más grandes y más accesibles, como igual los mercados que tenemos cerca. Estados Unidos y México son las economías que analizaremos para determinar los activos del portafolio. Entendiendo la economía, tomaremos una decisión de qué industrias invertir. A partir de la selección de industrias, compararemos los múltiplos de las empresas para seleccionar los activos adecuados. Mezclamos nuestra selección de empresas con deuda gubernamental y corporativa, y posteriormente con activos alternativos para diversificar.

# Análisis Macroeconomico

-   ¿De donde se genera el crecimiento económico de Estados Unidos y México?
-   ¿De su sector primario, secundario o terciario?
-   ¿Es una economía guiada por el gasto de consumidores o por producción industrial, o por exportaciones?

## Producto Interno Bruto 
```{r, include=FALSE}
library(tidyverse)
library(psych)
library(visdat)
library(readr)
library(readxl)
library(quantmod)
```

### Estados Unidos (GDP)
```{r, echo=FALSE}

```

### México (PIB)
```{r, echo=FALSE}

```

## Inflación

### Estados Unidos (CPI)
```{r, include=FALSE}

```

### Méico (INPC)
```{r}

```

## Tasas de Interes

### Estados Unidos
```{r}

```

### Méxcio
```{r}

```

# Activos Alternativos
## ¿Cómo decidir que alternativos incluir?
De acuerdo con David Kelly, especialista en *Global Market Insight Strategy* de J.P. Morgan, los alternativos son activos que se deben de agregar al portafolio con un proposito en mente. ¿Cuál es el desafio del portafolio? Si nuuestro objetivo es maximizar *Rate of Return*, incluir **Hedge Funds* no sea la mejor idea, en cambi incluir *Private Equity* sería un mejor camino. 
Para el portafolio del Banco Interamericano de Desarrollo se bus

Agrupar nuestras Convicciones de Manejo de Activos en distintas perspectivas

## Atributos que estamos buscando en 2022

-   Los mercados de capitales son volátiles.
-   "We like fundamental driven returns, rather than those from technical factors"
-   Floating rate, shorter maturity assets
-   poritive real yields Integration
-   "Assets that focus on the integration with themes of tech inovation, esg, demographic shifts, consumer shifts.
-   Asset selection lense: We like strategies that focus on the middle market in the financial alternatives.
-   Execution lense: We are on the golden period of active management, record dispertion.

## Marco para alocación de alternativos. Marco macroeconomico y atributos

Outcome lense perspective:

```{r}
# facet_grit: Graficar el Adj. Price, y Rendimiento y … de los activos alternativos
#S&P5 %>%
#  ggplot(aes(Profit, Adj.Close))+
#  geom_point()+
#  facet_wrap(~Industry + Country)
```

```{r}
# scatter plots: 
#S&P5 %>%
#  ggplot(aes(Profit, Adj.Close))+
#  geom_point()+
#  facet_wrap(~Industry + Country)
```

```{r}
# graph 3. 
#ggplot(aes())+
#  geom_point(col = "Blue", alpha=0.4)
#  facet_wrap(~Asset + Alternative_Asset_Type)
```
-----------------------------
# Análisis de Industria
# Análisis de Empresas
# Valuación de Instrumentos Tradicionales de Renta Fija
# Valuación de Instrumentos Tradicionales de Renta Variable
# Portafolio Tradicional

```{r, include=FALSE}
Equity <- c("BSMXB.MX", "VOLARA.MX", "TLEVISACPO.MX", "FEMSAUBD.MX", "CEMEXCPO.MX", "LABB.MX", "AGUA.MX", "KIMBERA.MX", "NEMAKA.MX", "AMZN", "WM", "NVS", "SAN", "BIMBOA.MX", "C", "NVDA")
getSymbols(Equity, from=as.Date("2017-02-05"), to=Sys.Date())

Equity_ad <- NULL
for(i in Equity){
  assign(paste0("Ad_",i), Ad(get(i)))
  Equity_ad <- c(Equity_ad, paste0("Ad_",i))
}

Equity_Portfolio <- merge.xts(get(Equity_ad[1]),
                       get(Equity_ad[2]),
                       join = "inner")

for(i in 3:length(Equity_ad)){
  Equity_Portfolio <- merge.xts(Equity_Portfolio,
                         get(Equity_ad[i]),
                         join = "inner")
}
Equity_Returns <- Return.calculate(Equity_Portfolio)[-1,]
```
Portafolio acciones
```{r, echo=FALSE}
Eq_Specs_Port <- portfolio.spec(c("BSMXB.MX", "VOLARA.MX", "TLEVISACPO.MX", "FEMSAUBD.MX", "CEMEXCPO.MX", "LABB.MX", "AGUA.MX", "KIMBERA.MX", "NEMAKA.MX", "AMZN", "WM", "NVS", "SAN", "BIMBOA.MX", "C", "NVDA"))
##### Add Constraints #####
Eq_Specs_Port <- add.constraint(Eq_Specs_Port,
                                type="full_investment")
Eq_Specs_Port <- add.constraint(Eq_Specs_Port,
                                type="long_only")

##### Add Objective #####
Eq_Specs_Port <- add.objective(Eq_Specs_Port,
                               type="risk",
                               name="StdDev")
Eq_Specs_Port <- add.objective(Eq_Specs_Port,
                               type='return',
                               name='mean')
Eq_Specs_Port
```
Optimización NIG para Eq_Specs_Port
```{r}
covnig<-function(R,portfolio){
  a<-fit.NIGmv(R,silent=TRUE)
  COV<-a@variance
  mu<-a@expected.value
  mu<-matrix(mu,ncol = 1)
  resultado<-list(mu=mu,sigma=COV)
  return(resultado)
}

Optimized_Port_NIG <- optimize.portfolio(Equity_Rend_log,
                                         Eq_Specs_Port,
                                         momentFUN = covnig,
                                         optimize_method = "random",
                                         trace = TRUE)
```

```{r}
chart.Weights(Optimized_Port_NIG, plot.type = "barplot")
W_R_NIG <- extractWeights(Optimized_Port_NIG)
W_R_NIG
```
```{r}
sum(W_R_NIG)
```
```{r}
Return_Port_NIG <- Return.portfolio(Equity_Rend_log, W_R_NIG)
plot(cumsum(Return_Port_NIG))
```

```{r, echo=FALSE}
table.AnnualizedReturns(Return_Port_NIG,
                        scale = 252,
                        geometric = FALSE)
```
```{r, echo=FALSE}
Return.cumulative(Return_Port_NIG,
                  geometric = FALSE)
```
```{r, echo=FALSE}
chart.RiskReward(Optimized_Port_NIG,
                 risk.col = 'StdDev',
                 return.col = 'mean',
                 chart.assets = TRUE)

```


-----------------------------
# Valuación de Commodities

```{r, include=FALSE}
Commodities <- c("KC=F", "SB=F", "GC=F", "SI=F", "ZW=F")
getSymbols(Commodities, from=as.Date("2017-02-05"), to=Sys.Date())

Commodities_ad <- NULL
for(i in Commodities){
  assign(paste0("Ad_",i), Ad(get(i)))
  Commodities_ad <- c(Commodities_ad, paste0("Ad_",i))
}

Commodities_Portfolio <- merge.xts(get(Commodities_ad[1]),
                       get(Commodities_ad[2]),
                       join = "inner")

for(i in 3:length(Commodities_ad)){
  Commodities_Portfolio <- merge.xts(Commodities_Portfolio,
                         get(Commodities_ad[i]),
                         join = "inner")
}
Commodities_Returns <- Return.calculate(Commodities_Portfolio)[-1,]
```
Precios Ajustados de Portafolio Commodities
```{r}
dta_fram_commodities <- as.data.frame(Commodities_Portfolio)
dta_fram_commodities <- dta_fram_commodities %>%
  mutate(fecha=index(Commodities_Portfolio))
dta_fram_commodities_tidy <- dta_fram_commodities %>%
  gather(-fecha, value = Rendimiento, key=Activo_comm)
dta_fram_commodities_tidy %>%
  ggplot(aes(x=fecha, y=Rendimiento, col=Activo_comm))+
  geom_line()+
  scale_y_log10()
```
```{r}
dta_fram_commodities_tidy %>%
  ggplot(aes(x=fecha, y=Rendimiento, col=Activo_comm))+
  geom_line()+
  facet_wrap(.~Activo_comm, scales = "free")
```

####
```{r, echo=FALSE}
Alternatives_Portfolio %>%
  ggplot(aes(KC.F.Adjusted))+
  geom_density()
```
Retornos de Portafolio Alternativo
####
```{r, echo=FALSE}
Alternative_Returns %>%
  ggplot(aes(KC.F.Adjusted))+
  geom_density()
```

## Correlación entre Commodities y el Portafolio Tradicional
```{r}
Gold_correlation <- rollapply(data = Commodities_Returns, 
                              width = 253, 
                              function(x) cor(x[,4], x[,7]), 
                              by.column = F)
chartSeries(Gold_correlation)

#Average correlation 
mean(na.omit(Gold_correlation))
```

----------------------------------
# Valuación de FIBRAS
```{r}
Fibras <- c("FMTY14.MX", "FUNO11.MX", "FIBRAPL14.MX", "FIBRAMQ12.MX")
getSymbols(Fibras)

Fibras_ad <- NULL
for(i in Fibras){
  assign(paste0("Ad_",i), Ad(get(i)))
  Commodities_ad <- c(Commodities_ad, paste0("Ad_",i))
}

Commodities_Portfolio <- merge.xts(get(Commodities_ad[1]),
                       get(Commodities_ad[2]),
                       join = "inner")

for(i in 3:length(Commodities_ad)){
  Commodities_Portfolio <- merge.xts(Commodities_Portfolio,
                         get(Commodities_ad[i]),
                         join = "inner")
}
Commodities_Returns <- Return.calculate(Commodities_Portfolio)[-1,]
```
```{r}
dta_fram_commodities_tidy %>%
  ggplot(aes(x=fecha, y=Rendimiento, col=Activo_comm))+
  geom_line()+
  facet_wrap(.~Activo_comm, scales = "free")
```

---------------------------------
# Creación del Portafolio
Create the Portfolio Object
```{r}
Specs_Port_Alter_1 <- portfolio.spec(Alternatives)
```
Add Constraints
```{r, echo=FALSE}
Specs_Port_Alter_1 <- add.constraint(Specs_Port_Alter_1,
                                     type="full_investment")
Specs_Port_Alter_1 <- add.constraint(Specs_Port_Alter_1,
                                     type="long_only")
```
Add Objective
```{r}
Specs_Port_Alter_1 <- add.objective(Specs_Port_Alter_1,
                                    type="risk",
                                    name="StdDev")
Specs_Port_Alter_1 <- add.objective(Specs_Port_Alter_1,
                                    type='return',
                                    name='mean')
Specs_Port_Alter_1
```

```{r}
covnig<-function(R, portfolio){
  a <- fit.NIGmv(R,
                 silent=TRUE)
  COV <- a@variance
  mu <- a@expected.value
  mu <- matrix(mu,ncol = 1)
  resultado<-list(mu=mu,
                  sigma=COV)
  return(resultado)
}
covnig(Returns)
```
Optimization
```{r}
Optimized_Port1 <- optimize.portfolio(Returns,
                                      Specs_Port1, 
                                      momentFUN = covnig)
Optimized_Port1
```
```{r}
chart.Weights(Optimized_Port1)
plot.ty()
W <- extractWeights(Optimized_Port1)
W
sum(W)
cor(Returns)
```
# Evaluación del Portafolio
## Análisis de Riesgo
```{r}
Return_opt <- Return.portfolio(Returns,W)

table.AnnualizedReturns(Return_opt,
                        scale = 252,
                        geometric = FALSE)
Return.cumulative(Return_opt,
                  geometric = FALSE)
```